## Deploy

deploy: 모든 사람들이 접근할 수있는 컴퓨터에 코드를 배포하는 것.

***알게된 사실: nvm 으로 버전을 관리(nvm - node version manager)**

항상 dependency 를 체크해야 한다!
branch마다 port number를 따로 둘때도 있음
***싱글페이지 앱이란 - html이 하나인것을 말한다.**
build 파일에 유저가 사용할것을 다 담으면 S3에 올릴 수 있다.
s3라는 버켓에 담아서 css,js,html을 한번에 줄 수 있다.

ec2라는 곳에 노드서버 코드를 올려서 ec2와 통신하게 한다. 내 컴퓨터랑은 소통하지 않는다.
ec2에서 인스턴스는 하나의 컴퓨터이고,  ip주소가있다.

***node_modules는 github에 올리면 안되기때문에 .gitignore에 /node_modules로 안올라가게 막는다.**

### SSH란?

SSH는 네트워크 프로토콜중 하나로 보안적으로 통신을 하기 위해 사용하는 프로토콜.

사용하는 예는 크게 

1. 데이터 전송
2. 원격 제어

두가지가 있다. 

첫번째 예는 GITHUB에 전송하는 경우가 있는데 우리가 PUSH를 할 때 SSH를 활용해 파일을 전송한다.

두번째는 이번에 사용한 AWS 인스턴스 접속인데 이는 밑에서 한번더 보자.

SSH는 Private Key와 Public Key가 있는데 이 키들은 항상 한 쌍으로 작동한다.

public key는 암호화를 하는 key인데 복호화는 하지 못한다.

이때 private키가 복호화하는 것 인데, 노출되면 안되는 key이기 때문에 컴퓨터 내부에 저장하게 된다.

따라서 인스턴스에 접속할 때에는 local에 저장되어 있는 private key를 비교하여 접속을 할 수 있는 것이다.

ssh는 기본적으로 22번 포트를 쓴다.



*http와의 차이: http는 기본적으로 80번 포트를 사용한다. 

그리고 http는 클라이언트와 서버 사이에 이루어지는 요청/응답 프로토콜이다. (ssh는 요청, 응답이 없음)

*tcp/ip란: 수 많은 프로그램들이 통신하는데 가장 기반이 되는 프로토콜. 흔히 말하는 127.0.0.1 과 같은 것.

### EC2

EC2란?

- 클라우드에서 확장된 컴퓨터를 제공. 이를 사용하면 하드웨어에 투자할 필요가 없음 가상서버를 구축하고 보안 및 네트워크 구성과 스토리지 관리가 가능.  인스턴스를 생성해서 서버를 올림

인스턴스: 가상 컴퓨터 환경

키 페어를 사용하여 인스턴스 로그인 정보 보호

인스턴스는 종료시 삭제됨

### S3

S3란?

- 인터넷 상에 있는 스토리지. 클라이언트 build를 올림

-출처: aws 사용 설명서



***127.0.0.1과 같이 숫자로 되어있는 ip주소를 입력할 때도 요청을 보내려면 http를 붙여야함**



S3는 정적이기 때문에 client를 EC2라는 좋은 컴퓨터에 두는 것보다 S3에 두는게 좋음.

RDS는 여러 EC2가 쓸 수 있기 때문에 따로 빼기도 함

 

### EC2의 인스턴스에서 작업할 때 배포판과 개발판을 나눠서 작업하는 방법

***방법 1***    process.env.NODE_ENV 를 쉘스크립트에서 export NODE_ENV = 'production' 치면 환경 변경됨

**echo $NODE_ENV로 확인가능**

- 위의 키워드로 확인하면서 작업해야 할 것 같음

development는 서버를 끄고 키면서 개발할 수 있음 이미배포되어 있는 경우

***방법 2***    .env 파일을 따로 만들어서 port를 바꿔가면서 쓸 수도 있음.



알게된사실: ec2를 어떤 보안그룹에 연결하고 rds를 다른 그룹에 연결한 후 rds가 속한 그룹에 인바운드를 유형을 mysql로 하고 소스를 해당 ec2또는 ec2가 속한 그룹 자체에 대해 열어주면 접근이 가능하다.

- 보안그룹자체를 연결하면 404에러가 뜨지않고 ip주소를 연결하면 에러가 뜸 왜그런가?



CI/CD 는 자동으로 배포가 되는 것을 일컫는다.





### sprint review

**비유를 들어서 S3와 EC2 flow를 설명하자면 S3는 마치 앱스토어에서 배포를 받은 것과 같은데 어떤 유저든지 그 URL을 치고 들어가면 S3에서 파일을 로딩하고 EC2랑 직접 통신한다.**



s3는 걸러서 열필요가 있음 ec2는 사실상 여러곳에서 요청이 오는 서버기 때문에 anywhere로 열어줘야함

**s3는 Getobject라는 것만 열어면 유저가 가져오는 것만 가능하다.**

```java	
{
    "Version": "2012-10-17",
    "Id": "Policy1548471262727",
    "Statement": [
        {
            "Sid": "Stmt1548471246936",
            "Effect": "Allow",
            "Principal": "*",
            "Action": [
                "s3:GetObject" // 이 부분이 ALL이면 가져가고 올리는 것도 가능함
            ],
            "Resource": "arn:aws:s3:::elasticbeanstalk-ap-northeast-2-398271762700/*"
        }
    ]
}
```



- 앞으로 개발을 하면서 CI/CD를 쓰면 ssh를 접속할 일이 거의 없고 지양함

- rds s3 ec2를 따로 구분하는 것은 ui 측면으로 편하게 보기 위함이 큼
- CI/CD를 이용하여 하루에 한번? 최대한 자주 배포해보면서 테스트 해봐야한다.

클라우드 프론트라는 기술로 버킷을 모든 세계에 내 버킷을 뿌릴 수 있음.